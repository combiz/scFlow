---
  title: "scflow: Guided Tutorial for using scFlowExampledata"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
author: Nurun fancy, Combiz Khozoie
---

  ```{r eval=TRUE, include=FALSE}
knitr::opts_chunk$set(include = TRUE, collapse = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
matrix_fp <- "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/tmp_ZeiselSCFLOW/individual_1/"
samplesheet_fp <- "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/tmp_ZeiselSCFLOW/SampleSheet.tsv"
ensembl_fp <- "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/ensembl_mappings.tsv"
```

#Running scflow using the scFlowExample data

You must have hdf5 setup on your system to run this. If using linux, run "sudo apt-get install libhdf5-dev".

## Install packages

Install `scflow` in RStudio from this [link](https://github.com/combiz/scflow/wiki/Installing-package-from-a-private-github-repo). For dependecy related issues check this [link](https://github.com/combiz/scflow/wiki).

## Preprocessing example dataset

To preprocess the example dataset the following packages should be installed.

```{r eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}
BiocManager::install("DropletUtils")

install.packages("ids")

devtools::install_github("NathanSkene/One2One")
```

Preprocess the `scFlowExample` dataset following this [link](https://github.com/neurogenomics/scFlowExample).

## Running _scflow_
The basic `scflow` workflow for sample QC begins with the import of the feature-barcode sparse matrix with `read_sparse_matrix`.  The metadata for the sample is then imported from a sample sheet with `read_metadata`.  A SingleCellExperiment object is created from the matrix and the metadata using `generate_sce` which is then annotated with both gene and cell-level data using `annotate_sce`.  We then filter the SingleCellExperiment to select only cells and genes meeting our QC criteria using `filter_sce`.  We can then optionally find singlets in our filtered SingleCellExperiment using `find_singlets` before filtering them out again with `filter_sce`.  A complete QC report can then be generated using `report_qc_sce` before saving the filtered and quality-controlled SingleCellExperiment with `write_sce`.

### Step one - import the matrix and metadata

```{r eval=TRUE, results="hide", include=FALSE}
matrix_fp <- paste(system.file("extdata", package = "scflow"), "/", "individual_1")
```


```{r eval=TRUE, results="hide"}
library(scflow)
mat <- read_sparse_matrix(matrix_fp)
```

Next we retrieve the metadata by pointing to a Sample Sheet and specifying a unique identifier (unique_key) in a specific column (key_colname):

  ```{r eval=TRUE, message=TRUE}
metadata <- read_metadata(
  unique_key = "lodut",
  key_colname = "manifest",
  samplesheet_path = samplesheet_fp
)
```

For downstream analyses it’s important that the variable classes are correctly specified. Carefully inspect the metadata classes in brackets. In the above example we see that the _individual_ were imported as integer rather than factor variables. Let’s correct this by reloading the metadata, this time specifying the correct variable classes for this variable:-

  ```{r eval=TRUE, message=TRUE}
var_classes <- c(
  individual = "factor"
)

metadata <- read_metadata(
  unique_key = "lodut",
  key_colname = "manifest",
  samplesheet_path = samplesheet_fp,
  col_classes = var_classes
)
```

With the metadata imported with the correct variable classes, and the previously loaded sparse matrix, we can generate our `SingleCellExperiment` object:-

  ```{r eval=TRUE, results="hide"}
sce <- generate_sce(mat, metadata)
```

The SingleCellExperiment object was succesfully created and we can now proceed with annotation.

```{r eval=TRUE, message=TRUE}
sce
```

### Step two -- Annotate the SingleCellExperiment

In `scflow` we specify all of our QC preferences and cutoffs with the `annotate_sce` command.  This will also produce plots in the `sce@metadata` slot allowing rapid revision and optimization of QC parameters.  Let's start with the default parameters by simply providing the `SingleCellExperiment` object to the `annotate_sce` function:-


```{r eval=TRUE, message=TRUE}
sce <- annotate_sce(
  sce,
  ensembl_mapping_file = ensembl_fp
)
```

A list of QC plots are available to browse in the `sce@metadata$qc_plots`, e.g.

```{r eval=TRUE, message=TRUE}
sce@metadata$qc_plots$number_genes_vs_count_depth
```

After running `annotate_sce` we may examine the plots and assess whether the applied thresholds are sensible for the sample.  The effects of different parameters can be explored by iterating through the above `generate_sce` and `annotate_sce` functions until satisfied with the settings.

The next step is to filter the SingleCellExperiment with `filter_sce`: -

```{r eval=TRUE, message=TRUE}
sce <- filter_sce(sce)
```

### Step three -- Finding singlets and discarding multiplets

At this stage we may wish to identify singlets in the `SingleCellExperiment` and discard any multiplets.  In `scflow` we simply run `find_singlets` and specify our preferred multiplet identification algorithm.  Here we will use `doubletfinder` (This will take a while depending on the cell numbers):-

```{r eval=TRUE, results="hide"}
sce <- find_singlets(sce, "doubletfinder", pK = 0.005, vars_to_regress_out = c("nCount_RNA", "pc_mito"))
```

Now we can filter out these multiplets with `filter_sce`:-

```{r eval=TRUE, results="hide"}
sce <- filter_sce(sce)
```

You can see the remaining cells after all the filtering done by:

```{r eval=TRUE, message=TRUE}
dim(sce)
```

Finally we produce a report with `report_qc_sce` (this takes a few minutes): -

```{r eval=FALSE}
report_qc_sce(sce, report_file = "qc_report_scflow_individual_1")
```

And save our SingleCellExperiment: -
```{r eval=FALSE}
write_sce(sce, "./sce_individual_1")
```


### Step four -- Merging multiple datasets into one _SingleCellExperiment_ object

Follow step one-three for all individual samples and save them using `write_sce` function. Then we read the individual `SingleCellExperiment` using `read_sce` into a list and merge them using `merge_sce` function.

```{r eval=FALSE}
sce_path <- dir(
  path = "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/",
  pattern = "sce_individual",
  full.names = TRUE
)

sce_pathlist <- list()

for (i in sce_path) {
  sce_pathlist[[i]] <- i
}

sce_list <- lapply(sce_pathlist, read_sce)

sce_merged <- merge_sce(
  sce_list,
  ensembl_mapping_file = ensembl_fp
)
```


Then we write the merged `SingleCellExperiment` object.

```{r eval=FALSE}
write_sce(
  sce = sce_merged,
  folder_path = "./sce_merged"
)
```

### Step five -- Dimension reduction and clustering

Once we merge all the samples into one `SingleCellExperiment` object we can move to the next steps of dimension reduction and clustering. Here dimension reduction is performed using multiple methods by default i.e. "PCA", "tSNE", "UMAP", "UMAP3D". Once the dimension reduction step is done the `SingleCellExperiment` object is ready for clustering.

```{r eval=TRUE, results="hide"}
sce_merged <- read_sce(
  "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/sce_merged/"
  )
```

```{r eval=TRUE, message=TRUE}
dim(sce_merged)
```

```{r eval=TRUE, results="hide"}
sce_merged <- reduce_dims_sce(sce_merged, pca_dims = 5)
```

We can now plot tSNE:-

```{r eval=TRUE, message=TRUE}
plot_umap_with_feature(sce_merged, feature_dim = "diagnosis", reduced_dim = "tSNE")
```

The next step is to cluster all the cells using `cluster_sce` command.

```{r eval=TRUE, results="hide"}
sce_merged <- cluster_sce(sce_merged)
```

We can then plot the clusters:-

```{r eval=TRUE, message=TRUE}
plot_umap_with_feature(sce_merged, feature_dim = "clusters", reduced_dim = "tSNE")
```

The next step is to annotate the celltypes for each cluster. Here, we will use the package `ewce`. For this we use the following command (This may take a while):-

```{r eval=TRUE, results="hide"}
sce_merged <- map_celltypes_sce(sce_merged,
  ctd_folder = "/mnt/af7147ab-070c-4618-bd4f-4a6287cec1f4/Nurun/scflowExample/ctd/"
)
```

The celltypes for each cell can be found in `sce_merged@colData$cluster_celltype` slot. We can also generate tSNE plot for each celltype.

```{r eval=TRUE, message=TRUE}
plot_umap_with_feature(sce_merged, feature_dim = "cluster_celltype", reduced_dim = "tSNE")
```

###Performing differential expression analysis following by impacted pathway analysis

We need to subset the merged `SingleCellExperiment` object to perform differential expression analysis. Here we are using `MASTZLM` for differential expression analysis. For example, we are interested in performing DE analysis in the `Microglia` cell cluster. So, we first subset the `Micro` cluster.

```{r eval=TRUE}
sce_subset <- sce_merged[, sce_merged$cluster_celltype == "Micro"]
```

We need to specify the colData column name as dependent_var as the variable of interest for DE analysis. For example here we want to perform DE analysis between Case and Controls which is found in `diagnosis` column. ref_class is the reference group for DE analysis. If there are any confounding variables those colData names can be passed through confounding_vars argument.

```{r eval=TRUE, results="hide"}
result_de <- perform_de(
  sce_subset,
  dependent_var = "diagnosis",
  ref_class = "Controls",
  confounding_vars = c("cngeneson", "sex"))
```

result_de is a list of DE tables. If there are more than one group to be compared against the reference (here `Controls`) group they will all be merged into the `result_de@Controls_Merged_Results` slot.


```{r eval=TRUE, message=TRUE}
result_de$Controls_vs_diagnosisCases
```
